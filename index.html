<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Web Widgets</title>
    
    <!-- Google Fonts Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Inter:wght@300;400;700&family=Playfair+Display:ital,wght@1,400&family=Amiri:wght@400;700&family=Montserrat:wght@400;700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #1a1a1a;
            --glass-bg: rgba(30, 30, 30, 0.6);
            --panel-bg: rgba(30, 30, 30, 0.9);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.6);
            --accent: #0a84ff;
            --font-stack: 'Inter', sans-serif;
            
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-active: 0 12px 32px rgba(0, 0, 0, 0.4);
            --danger: #ff453a;
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
            font-family: var(--font-stack);
            color: var(--text-main);
            transition: background-image 0.5s ease, color 0.3s ease, font-family 0.3s ease;
        }

        /* RTL Support */
        body[dir="rtl"] { direction: rtl; text-align: right; }
        body[dir="rtl"] .menu-bar { left: 10px; right: auto; }
        body[dir="rtl"] .panel { left: 10px; right: auto; }
        body[dir="rtl"] .widget-controls { left: 5px; right: auto; }
        body[dir="rtl"] .todo-check { margin-right: 10px; margin-left: 0; }
        body[dir="ltr"] .todo-check { margin-left: 10px; margin-right: 0; }

        /* --- UI Overlay --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1000;
            opacity: 0; transition: opacity 0.3s ease;
        }
        body.ui-visible #ui-layer { opacity: 1; }

        .menu-bar {
            position: absolute; top: 10px; right: 10px;
            display: flex; gap: 10px;
            pointer-events: auto;
        }

        .btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main); padding: 8px 12px;
            border-radius: 8px; cursor: pointer;
            backdrop-filter: blur(10px);
            font-size: 14px; transition: all 0.2s;
            font-family: inherit;
        }
        .btn:hover { background: var(--accent); border-color: var(--accent); color: white; }
        .btn.danger { background: rgba(255, 69, 58, 0.2); border-color: var(--danger); color: var(--danger); }
        .btn.danger:hover { background: var(--danger); color: white; }

        .panel {
            position: absolute; top: 50px; right: 10px;
            width: 340px;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            pointer-events: auto;
            display: none;
            box-shadow: var(--shadow-active);
            max-height: 80vh;
            overflow-y: auto;
            color: var(--text-main);
        }
        .panel.active { display: block; animation: fadeIn 0.2s ease; }

        .control-group { margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; }
        .control-group:last-child { border-bottom: none; }
        .control-group label { display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        select, input[type="text"], input[type="url"], input[type="color"] {
            width: 100%; padding: 8px; 
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--glass-border);
            border-radius: 6px; color: var(--text-main); outline: none;
            font-family: inherit;
        }
        select option, input option { background-color: #222; color: white; }
        select:focus, input:focus { border-color: var(--accent); background: rgba(255,255,255,0.15); }

        /* --- Grid & Widgets --- */
        #widget-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }

        .widget {
            position: absolute;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            box-shadow: var(--shadow-light);
            display: flex; flex-direction: column;
            overflow: hidden;
            text-decoration: none; 
            color: var(--text-main);
        }

        /* Drag Handle */
        .widget-drag-handle {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; opacity: 0; pointer-events: none; cursor: default;
        }

        /* Resize Handle */
        .widget-resize-handle {
            position: absolute; bottom: 0; right: 0; width: 40px; height: 40px;
            z-index: 20; cursor: nwse-resize; opacity: 0; pointer-events: none;
            transition: opacity 0.2s;
            background: linear-gradient(to top left, transparent 50%, var(--text-dim) 50%);
            border-bottom-right-radius: 18px;
        }
        body[dir="rtl"] .widget-resize-handle {
            right: auto; left: 0; cursor: nesw-resize;
            background: linear-gradient(to top right, transparent 50%, var(--text-dim) 50%);
            border-bottom-right-radius: 0; border-bottom-left-radius: 18px;
        }

        /* Controls */
        .widget-controls {
            position: absolute; top: 5px; right: 5px;
            display: flex; gap: 5px; opacity: 0; pointer-events: none;
            z-index: 30; transition: opacity 0.2s;
        }
        
        body.edit-mode .widget-drag-handle { opacity: 0; pointer-events: auto; cursor: grab; }
        body.edit-mode .widget-drag-handle:active { cursor: grabbing; }
        body.edit-mode .widget-resize-handle, body.edit-mode .widget-controls { opacity: 1; pointer-events: auto; }
        body.edit-mode .widget { border-color: rgba(255,255,255,0.3); box-shadow: 0 0 0 1px var(--accent); }

        .widget-content {
            padding: 20px; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center;
            pointer-events: none; 
            position: relative; z-index: 1;
        }

        /* --- Widget Specifics --- */
        .w-time { text-align: center; }
        .time-display { font-size: 4rem; font-weight: 200; letter-spacing: -2px; line-height: 1; margin: 0; }
        .date-display { font-size: 1.2rem; color: var(--text-dim); margin-top: 5px; font-weight: 400; }

        .w-weather { text-align: center; }
        .weather-temp { font-size: 3.5rem; font-weight: 300; }
        .weather-loc { font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 5px; }
        .weather-icon { font-size: 2rem; margin-bottom: 10px; transition: opacity 0.3s; }
        .w-weather[data-width="2"] .weather-icon { display: none; }
        .w-weather[data-width="2"] .weather-temp { font-size: 2.5rem; }

        .w-prayer { text-align: left; }
        body[dir="rtl"] .w-prayer { text-align: right; }
        .prayer-header { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; }
        .hijri-date { font-size: 0.9rem; color: var(--accent); margin-bottom: 10px; font-weight: 600; text-align: center; }
        .prayer-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.95rem; cursor: default; transition: background 0.2s; padding: 4px; border-radius: 6px; }
        .prayer-row:hover { background: rgba(255,255,255,0.1); }
        .prayer-row.active { color: var(--accent); font-weight: bold; background: rgba(10, 132, 255, 0.1); }
        .prayer-progress { margin-top: 10px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .prayer-bar { height: 100%; background: var(--accent); width: 0%; transition: width 1s linear; }
        .next-prayer-label { font-size: 0.8rem; color: var(--text-dim); margin-top: 5px; text-align: center; }
        .w-prayer[data-height="3"] .prayer-list { display: none; }
        .w-prayer[data-height="3"] .prayer-header { font-size: 1rem; border: none; margin: 0; text-align: center; }
        .w-prayer[data-height="3"] .prayer-progress { margin-top: 20px; }

        .w-todo, .w-notes { text-align: left; }
        body[dir="rtl"] .w-todo, body[dir="rtl"] .w-notes { text-align: right; }
        .todo-container { height: 100%; overflow-y: auto; pointer-events: auto; }
        .todo-item { display: flex; align-items: center; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-dim); }
        .todo-item.done { text-decoration: line-through; opacity: 0.5; }
        .todo-input { width: 100%; background: transparent; border: none; color: var(--text-main); font-family: inherit; outline: none; font-size: 0.9rem; pointer-events: auto; margin-top: 5px; }
        .todo-check { width: 16px; height: 16px; border: 2px solid var(--text-dim); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .todo-item.done .todo-check { background-color: var(--accent); border-color: var(--accent); }
        .todo-item.done .todo-check::after { content: 'âœ”'; color: white; font-size: 10px; }

        .notes-area, .todo-input::placeholder { color: var(--text-dim); opacity: 0.5; }

        .w-bookmark { justify-content: center; align-items: center; }
        .w-bookmark .widget-content { justify-content: center; align-items: center; text-align: center; height: 100%; }
        .bookmark-icon { font-size: 2.5rem; margin-bottom: 5px; line-height: 1; }
        .bookmark-title { font-size: 1rem; font-weight: 600; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        .mini-btn { background: rgba(255,0,0,0.3); border: none; color: var(--text-main); width: 20px; height: 20px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; }

        #grid-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(var(--glass-border) 1px, transparent 1px),
            linear-gradient(90deg, var(--glass-border) 1px, transparent 1px);
            background-size: var(--cell-size) var(--cell-size);
            pointer-events: none; opacity: 0; z-index: 0;
        }
        body.edit-mode #grid-overlay { opacity: 0.3; }

        .dynamic-form { display: none; margin-top: 10px; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; }
        .dynamic-form.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body dir="ltr">

    <div id="bg-layer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></div>
    
    <div id="grid-overlay"></div>
    <div id="widget-container"></div>

    <div id="ui-layer">
        <div class="menu-bar">
            <button class="btn" id="add-widget-btn" data-i18n="addWidget">+ Add Widget</button>
            <button class="btn" id="toggle-edit" data-i18n="editLayout">Edit Layout</button>
            <button class="btn" id="open-settings" data-i18n="settings">Settings</button>
        </div>

        <div class="panel" id="add-widget-panel">
            <h3 style="margin-top:0" data-i18n="addWidget">Add Widget</h3>
            <div class="control-group">
                <label data-i18n="selectType">Select Type</label>
                <select id="new-widget-type">
                    <option value="time" data-i18n="timeWidget">Time Clock</option>
                    <option value="weather" data-i18n="weatherWidget">Weather</option>
                    <option value="prayer" data-i18n="prayerWidget">Prayer Times</option>
                    <option value="todo" data-i18n="todoWidget">To-Do List</option>
                    <option value="notes" data-i18n="notesWidget">Notes</option>
                    <option value="bookmark" data-i18n="bookmarkWidget">Web Bookmark</option>
                </select>
            </div>
            
            <div id="form-bookmark" class="dynamic-form">
                <div class="control-group"><label data-i18n="title">Title</label><input type="text" id="bm-title" placeholder="e.g. YouTube"></div>
                <div class="control-group"><label>URL</label><input type="url" id="bm-url" placeholder="https://youtube.com"></div>
                <div class="control-group"><label data-i18n="icon">Icon (Emoji)</label><input type="text" id="bm-icon" value="ðŸ”—" style="text-align:center; font-size:1.2rem"></div>
                <div class="control-group"><label data-i18n="color">Color</label><input type="color" id="bm-color" value="#ff9500" style="height:40px; cursor:pointer"></div>
            </div>

            <button class="btn" style="width:100%" id="confirm-add-widget" data-i18n="addToLayout">Add to Layout</button>
        </div>

        <div class="panel" id="settings-panel">
            <h3 style="margin-top:0" data-i18n="settings">Settings</h3>
            
            <div class="control-group">
                <label data-i18n="language">Interface Language</label>
                <select id="ui-language">
                    <option value="en">English</option>
                    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                </select>
            </div>
            <div class="control-group">
                <label data-i18n="font">Font Style</label>
                <select id="ui-font"></select>
            </div>

            <div class="control-group">
                <label data-i18n="theme">Theme</label>
                <select id="ui-theme">
                    <option value="default" data-i18n="defaultTheme">Default (Dark)</option>
                    <option value="forest" data-i18n="forestTheme">Deep Forest</option>
                    <option value="mist" data-i18n="mistTheme">Mist Gray</option>
                    <option value="ivory" data-i18n="ivoryTheme">Ivory & Brown</option>
                </select>
            </div>

            <div class="control-group">
                <label data-i18n="gridSize">Grid Size: <span id="grid-size-val">80px</span></label>
                <input type="range" id="grid-size-input" min="50" max="150" value="80">
            </div>

            <div class="control-group">
                <label data-i18n="weatherLocation">Location (Weather & Prayer)</label>
                <select id="location-select"></select>
            </div>

            <div class="control-group">
                <label data-i18n="bgImage">Background Image</label>
                <input type="file" id="bg-upload" accept="image/*">
                <!-- Apply Button added -->
                <div style="display: flex; gap: 10px; margin-top: 5px;">
                    <button class="btn" id="apply-bg" style="flex:1; display:none;">Apply Background</button>
                    <button class="btn" id="reset-bg" data-i18n="resetBg">Reset Background</button>
                </div>
            </div>

            <div class="control-group">
                <button class="btn danger" style="width:100%" id="reset-layout" data-i18n="factoryReset">Factory Reset Layout</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            gridSize: 80, gap: 10, inactivityTimeout: 3000,
            defaultBg: 'https://images.unsplash.com/photo-1478760329108-5c3ed9d495a0?q=80&w=2574&auto=format&fit=crop'
        };

        const UAE_REGIONS = {
            abudhabi: { id: 'abudhabi', name: "Abu Dhabi", arName: "Ø£Ø¨Ùˆ Ø¸Ø¨ÙŠ", lat: 24.4539, lon: 54.3773, bounds: { n: 25.0, s: 23.5, e: 55.5, w: 52.0 } },
            dubai: { id: 'dubai', name: "Dubai", arName: "Ø¯Ø¨ÙŠ", lat: 25.2048, lon: 55.2708, bounds: { n: 25.4, s: 24.8, e: 55.5, w: 54.8 } },
            sharjah: { id: 'sharjah', name: "Sharjah", arName: "Ø§Ù„Ø´Ø§Ø±Ù‚Ø©", lat: 25.3578, lon: 55.3944, bounds: { n: 25.6, s: 25.0, e: 55.8, w: 55.2 } },
            ajman: { id: 'ajman', name: "Ajman", arName: "Ø¹Ø¬Ù…Ø§Ù†", lat: 25.4052, lon: 55.5136, bounds: { n: 25.5, s: 25.2, e: 55.7, w: 55.3 } },
            uaq: { id: 'uaq', name: "Umm Al Quwain", arName: "Ø£Ù… Ø§Ù„Ù‚ÙŠÙˆÙŠÙ†", lat: 25.5647, lon: 55.5552, bounds: { n: 25.7, s: 25.4, e: 56.0, w: 55.4 } },
            rak: { id: 'rak', name: "Ras Al Khaimah", arName: "Ø±Ø£Ø³ Ø§Ù„Ø®ÙŠÙ…Ø©", lat: 25.7346, lon: 55.9941, bounds: { n: 26.0, s: 25.3, e: 56.4, w: 55.6 } },
            fujairah: { id: 'fujairah', name: "Fujairah", arName: "Ø§Ù„ÙØ¬ÙŠØ±Ø©", lat: 25.1288, lon: 56.3265, bounds: { n: 25.6, s: 24.8, e: 56.6, w: 55.8 } }
        };

        const THEMES = {
            default: { bg: '#1a1a1a', glass: 'rgba(30, 30, 30, 0.6)', panel: 'rgba(30, 30, 30, 0.9)', border: 'rgba(255, 255, 255, 0.1)', text: '#ffffff', dim: 'rgba(255, 255, 255, 0.6)', accent: '#0a84ff' },
            forest: { bg: '#102C26', glass: 'rgba(16, 44, 38, 0.7)', panel: 'rgba(16, 44, 38, 0.92)', border: 'rgba(247, 231, 206, 0.2)', text: '#F7E7CE', dim: 'rgba(247, 231, 206, 0.7)', accent: '#F7E7CE' },
            mist: { bg: '#ECEFF1', glass: 'rgba(236, 239, 241, 0.7)', panel: 'rgba(236, 239, 241, 0.95)', border: 'rgba(25, 25, 112, 0.2)', text: '#191970', dim: 'rgba(25, 25, 112, 0.6)', accent: '#191970' },
            ivory: { bg: '#FFF2E1', glass: 'rgba(255, 242, 225, 0.8)', panel: 'rgba(255, 242, 225, 0.95)', border: 'rgba(167, 146, 119, 0.3)', text: '#5D4037', dim: 'rgba(93, 64, 55, 0.7)', accent: '#A79277' }
        };

        const FONTS = {
            en: [{ name: 'Inter (Modern)', family: "'Inter', sans-serif" }, { name: 'Playfair Display (Serif)', family: "'Playfair Display', serif" }, { name: 'Montserrat (Geometric)', family: "'Montserrat', sans-serif" }],
            ar: [{ name: 'Cairo (Modern)', family: "'Cairo', sans-serif" }, { name: 'Tajawal (Geometric)', family: "'Tajawal', sans-serif" }, { name: 'Amiri (Traditional)', family: "'Amiri', serif" }]
        };

        const TRANSLATIONS = {
            en: {
                addWidget: "+ Add Widget", editLayout: "Edit Layout", settings: "Settings",
                selectType: "Select Type", timeWidget: "Time Clock", weatherWidget: "Weather", prayerWidget: "Prayer Times", todoWidget: "To-Do List", notesWidget: "Notes", bookmarkWidget: "Web Bookmark",
                title: "Title", icon: "Icon (Emoji)", color: "Color", addToLayout: "Add to Layout",
                language: "Interface Language", font: "Font Style", theme: "Theme",
                defaultTheme: "Default (Dark)", forestTheme: "Deep Forest", mistTheme: "Mist Gray", ivoryTheme: "Ivory & Brown",
                gridSize: "Grid Size", bgImage: "Background Image", resetBg: "Reset Background", applyBg: "Apply Changes",
                weatherLocation: "Location (Weather & Prayer)", factoryReset: "Factory Reset Layout",
                autoLoc: "Auto Detect (GPS)",
                fajr: "Fajr", dhuhr: "Dhuhr", asr: "Asr", maghrib: "Maghrib", isha: "Isha",
                nextPrayer: "Next Prayer", iqamahIn: "Iqamah in", timePassed: "Time since Adhan",
                todoPlaceholder: "Add task and press Enter..."
            },
            ar: {
                addWidget: "+ Ø¥Ø¶Ø§ÙØ© ÙˆØ¯Ø¬Øª", editLayout: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ®Ø·ÙŠØ·", settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
                selectType: "Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹", timeWidget: "Ø³Ø§Ø¹Ø©", weatherWidget: "Ø·Ù‚Ø³", prayerWidget: "Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©", todoWidget: "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…", notesWidget: "Ù…Ù„Ø§Ø­Ø¸Ø§Øª", bookmarkWidget: "Ø±Ø§Ø¨Ø· ÙˆÙŠØ¨",
                title: "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", icon: "Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)", color: "Ø§Ù„Ù„ÙˆÙ†", addToLayout: "Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØªØ®Ø·ÙŠØ·",
                language: "Ù„ØºØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©", font: "Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·", theme: "Ø§Ù„Ù…Ø¸Ù‡Ø±",
                defaultTheme: "Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø¯Ø§ÙƒÙ†)", forestTheme: "Ø§Ù„ØºØ§Ø¨Ø© Ø§Ù„Ø¹Ù…ÙŠÙ‚Ø©", mistTheme: "Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ", ivoryTheme: "Ø¹Ø§Ø¬ÙŠ ÙˆØ¨Ù†ÙŠ",
                gridSize: "Ø­Ø¬Ù… Ø§Ù„Ø´Ø¨ÙƒØ©", bgImage: "ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©", resetBg: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®Ù„ÙÙŠØ©", applyBg: "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª",
                weatherLocation: "Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ù„Ø·Ù‚Ø³ ÙˆØ§Ù„ØµÙ„Ø§Ø©)", factoryReset: "Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹",
                autoLoc: "ÙƒØ´Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ (GPS)",
                fajr: "Ø§Ù„ÙØ¬Ø±", dhuhr: "Ø§Ù„Ø¸Ù‡Ø±", asr: "Ø§Ù„Ø¹ØµØ±", maghrib: "Ø§Ù„Ù…ØºØ±Ø¨", isha: "Ø§Ù„Ø¹Ø´Ø§Ø¡",
                nextPrayer: "Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©", iqamahIn: "Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ø¨Ø¹Ø¯", timePassed: "Ù…Ø±Ù‘ ÙˆÙ‚Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø°Ø§Ù†",
                todoPlaceholder: "Ø£Ø¶Ù Ù…Ù‡Ù…Ø© ÙˆØ§Ø¶ØºØ· Ø¥Ù†ØªØ±..."
            }
        };

        // SAFE STORAGE
        const Storage = {
            get: (key) => { try { return localStorage.getItem(key); } catch (e) { return null; } },
            set: (key, val) => {
                try { 
                    localStorage.setItem(key, val); 
                } catch (e) { 
                    console.warn("Storage full/failed", e); 
                }
            },
            remove: (key) => { try { localStorage.removeItem(key); } catch (e) {} }
        };

        const UAE_LOCATIONS = [{ id: 'auto', name: "Auto Detect (GPS)", arName: "ÙƒØ´Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ (GPS)", lat: null, lon: null }];
        Object.values(UAE_REGIONS).forEach(r => UAE_LOCATIONS.push(r));

        const STATE = {
            widgets: [], isEditing: false, dragTarget: null, resizeTarget: null,
            startX: 0, startY: 0, initialLeft: 0, initialTop: 0, initialW: 0, initialH: 0, idleTimer: null,
            lang: 'en', currentLoc: UAE_REGIONS.abudhabi, geoCache: null,
            pendingBg: null // For the "Apply" workflow
        };

        const DOM = {
            container: document.getElementById('widget-container'),
            gridOverlay: document.getElementById('grid-overlay'),
            bg: document.getElementById('bg-layer'),
            uiLayer: document.getElementById('ui-layer'),
            editBtn: document.getElementById('toggle-edit'),
            settingsBtn: document.getElementById('open-settings'),
            addWidgetBtn: document.getElementById('add-widget-btn'),
            settingsPanel: document.getElementById('settings-panel'),
            addWidgetPanel: document.getElementById('add-widget-panel'),
            gridSizeInput: document.getElementById('grid-size-input'),
            fileSizeVal: document.getElementById('grid-size-val'),
            langSelect: document.getElementById('ui-language'),
            fontSelect: document.getElementById('ui-font'),
            themeSelect: document.getElementById('ui-theme'),
            locSelect: document.getElementById('location-select'),
            applyBgBtn: document.getElementById('apply-bg')
        };

        // --- GEOLOCATION HELPER ---
        function detectLocationAndInitialize() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude, lon = pos.coords.longitude;
                    const detectedEmirate = mapCoordsToEmirate(lat, lon);
                    if (detectedEmirate) {
                        STATE.currentLoc = detectedEmirate; STATE.geoCache = { lat, lon }; DOM.locSelect.value = detectedEmirate.id;
                    } else {
                        STATE.currentLoc = UAE_LOCATIONS[0]; STATE.geoCache = { lat, lon }; DOM.locSelect.value = 'auto';
                    }
                    STATE.widgets.filter(w => w.type === 'weather' || w.type === 'prayer').forEach(w => w.refreshData());
                    saveSettings();
                },
                (err) => { console.warn("Geo denied"); }
            );
        }

        function mapCoordsToEmirate(lat, lon) {
            for (let key in UAE_REGIONS) {
                const r = UAE_REGIONS[key];
                if (lat >= r.bounds.s && lat <= r.bounds.n && lon >= r.bounds.w && lon <= r.bounds.e) return r;
            }
            return null;
        }

        function applyTheme(themeKey) {
            const t = THEMES[themeKey];
            if(!t) return;
            const root = document.documentElement;
            root.style.setProperty('--bg-color', t.bg);
            root.style.setProperty('--glass-bg', t.glass);
            root.style.setProperty('--panel-bg', t.panel);
            root.style.setProperty('--glass-border', t.border);
            root.style.setProperty('--text-main', t.text);
            root.style.setProperty('--text-dim', t.dim);
            root.style.setProperty('--accent', t.accent);
            Storage.set('widget_theme', themeKey);
        }

        function updateLanguage(lang) {
            STATE.lang = lang;
            document.body.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (TRANSLATIONS[lang][key]) el.innerText = TRANSLATIONS[lang][key];
            });

            DOM.fontSelect.innerHTML = '';
            FONTS[lang].forEach(f => {
                const opt = document.createElement('option'); opt.value = f.family; opt.innerText = f.name; DOM.fontSelect.appendChild(opt);
            });
            const savedFont = Storage.get('widget_font');
            if(savedFont) {
                DOM.fontSelect.value = savedFont;
                document.documentElement.style.setProperty('--font-stack', savedFont);
            }

            DOM.locSelect.innerHTML = '';
            UAE_LOCATIONS.forEach((loc, index) => {
                const opt = document.createElement('option'); opt.value = loc.id;
                opt.innerText = (lang === 'ar' && loc.arName) ? loc.arName : loc.name;
                if(loc.id === STATE.currentLoc.id) opt.selected = true;
                DOM.locSelect.appendChild(opt);
            });
            
            // Refresh ALL widgets
            STATE.widgets.forEach(w => w.refreshData());
            Storage.set('widget_lang', lang);
        }

        // --- WIDGET CLASSES ---

        class Widget {
            constructor(id, type, x, y, w, h, data = {}) {
                this.id = id; this.type = type; this.x = x; this.y = y; this.w = w; this.h = h; this.data = data;
                this.minW = 1; this.minH = 1; 
                this.el = null; this.contentRef = {};
                this.render();
            }
            render() {
                this.el = document.createElement('div');
                this.el.className = `widget w-${this.type}`;
                this.el.id = this.id;
                const handle = document.createElement('div'); handle.className = 'widget-drag-handle'; handle.addEventListener('mousedown', (e) => startDrag(e, this));
                const resizer = document.createElement('div'); resizer.className = 'widget-resize-handle'; resizer.addEventListener('mousedown', (e) => startResize(e, this));
                const controls = document.createElement('div'); controls.className = 'widget-controls';
                const closeBtn = document.createElement('button'); closeBtn.className = 'mini-btn'; closeBtn.innerHTML = 'Ã—'; closeBtn.onclick = () => removeWidget(this.id); controls.appendChild(closeBtn);
                const content = document.createElement('div'); content.className = 'widget-content';
                this.updateContent(content);
                this.el.appendChild(handle); this.el.appendChild(resizer); this.el.appendChild(controls); this.el.appendChild(content);
                DOM.container.appendChild(this.el);
                this.updateStyle();
                this.refreshData();
            }
            updateStyle() {
                const px = (val) => val * CONFIG.gridSize;
                this.el.style.width = `calc(${px(this.w)}px - ${CONFIG.gap}px)`;
                this.el.style.height = `calc(${px(this.h)}px - ${CONFIG.gap}px)`;
                this.el.style.left = `${px(this.x) + (CONFIG.gap/2)}px`;
                this.el.style.top = `${px(this.y) + (CONFIG.gap/2)}px`;
                this.el.style.transition = 'transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.2s, background-color 0.2s';
                this.el.setAttribute('data-width', this.w);
                this.el.setAttribute('data-height', this.h);
                if(this.renderResponsiveLayout) this.renderResponsiveLayout();
            }
            updateContent(container) {}
            refreshData() {}
        }

        class TimeWidget extends Widget {
            constructor(...args) {
                super(...args);
                this.minW = 3; this.minH = 2;
            }
            updateContent(container) {
                const time = document.createElement('h1'); time.className = 'time-display';
                const date = document.createElement('div'); date.className = 'date-display';
                container.appendChild(time); container.appendChild(date);
                this.contentRef = { time, date };
            }
            refreshData() {
                const now = new Date();
                let timeString = "";
                
                // FIX: Arabic 12h Manual Formatting
                if (STATE.lang === 'ar') {
                    let h = now.getHours();
                    const m = now.getMinutes();
                    const ampm = h >= 12 ? 'Ù…' : 'Øµ';
                    h = h > 12 ? h - 12 : (h === 0 ? 12 : h);
                    const min = m < 10 ? '0'+m : m;
                    timeString = `${h}:${min} ${ampm}`;
                } else {
                    timeString = now.toLocaleTimeString('en-US', {hour: 'numeric', minute:'2-digit', hour12: true});
                }

                this.contentRef.time.innerText = timeString;
                this.contentRef.date.innerText = now.toLocaleDateString(STATE.lang === 'ar' ? 'ar-UAE' : 'en-US', {weekday: 'long', month: 'short', day: 'numeric'});
            }
        }

        class WeatherWidget extends Widget {
            constructor(...args) {
                super(...args);
                this.minW = 2; this.minH = 2;
            }
            updateContent(container) {
                const loc = document.createElement('div'); loc.className = 'weather-loc';
                const icon = document.createElement('div'); icon.className = 'weather-icon';
                const temp = document.createElement('div'); temp.className = 'weather-temp';
                container.appendChild(loc); container.appendChild(icon); container.appendChild(temp);
                this.contentRef = { loc, icon, temp };
            }
            refreshData() {
                let lat = STATE.currentLoc.lat;
                let lon = STATE.currentLoc.lon;
                let city = STATE.currentLoc.name;
                if (STATE.lang === 'ar' && STATE.currentLoc.arName) city = STATE.currentLoc.arName;
                if (STATE.currentLoc.id === 'auto' && STATE.geoCache) {
                    lat = STATE.geoCache.lat; lon = STATE.geoCache.lon;
                    city = STATE.lang === 'ar' ? "Ù…ÙˆÙ‚Ø¹ÙŠ" : "My Location";
                }
                if (!lat || !lon) return;
                if (this.lastWeatherUpdate && Date.now() - this.lastWeatherUpdate < 600000 && this.lastCityName === city) return this.renderCachedWeather();
                fetchWeather({lat, lon, name: city}, this);
            }
            renderCachedWeather() {
                if (this.weatherCache) {
                    this.contentRef.loc.innerText = this.weatherCache.city;
                    this.contentRef.icon.innerText = this.weatherCache.icon;
                    this.contentRef.temp.innerText = `${Math.round(this.weatherCache.temp)}Â°`;
                }
            }
        }

        class PrayerWidget extends Widget {
            constructor(...args) {
                super(...args);
                this.minW = 3; this.minH = 3;
            }
            updateContent(container) {
                const hijri = document.createElement('div'); hijri.className = 'hijri-date'; hijri.id = `hijri-${this.id}`;
                const header = document.createElement('div'); header.className = 'prayer-header';
                const list = document.createElement('div'); list.className = 'prayer-list'; list.id = `plist-${this.id}`;
                const progress = document.createElement('div'); progress.className = 'prayer-progress';
                const bar = document.createElement('div'); bar.className = 'prayer-bar'; bar.id = `pbar-${this.id}`;
                const nextLabel = document.createElement('div'); nextLabel.className = 'next-prayer-label'; nextLabel.id = `plabel-${this.id}`;
                progress.appendChild(bar);
                container.appendChild(hijri); container.appendChild(header); container.appendChild(list); container.appendChild(progress); container.appendChild(nextLabel);
                this.contentRef = { header, list, bar, nextLabel, hijri };
            }
            refreshData() {
                let lat = STATE.currentLoc.lat;
                let lon = STATE.currentLoc.lon;
                if (STATE.currentLoc.id === 'auto' && STATE.geoCache) { lat = STATE.geoCache.lat; lon = STATE.geoCache.lon; }
                if (!lat || !lon) return;

                // Update Hijri
                const now = new Date();
                const hijriDate = new Intl.DateTimeFormat(STATE.lang === 'ar' ? 'ar-SA-u-ca-islamic' : 'en-US-u-ca-islamic', { dateStyle: 'long', calendar: 'islamic' }).format(now);
                if(this.contentRef.hijri) this.contentRef.hijri.innerText = hijriDate;

                const dateStr = `${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}`;
                const url = `https://api.aladhan.com/v1/timings/${dateStr}?latitude=${lat}&longitude=${lon}&method=17`;

                fetch(url).then(res => res.json()).then(data => {
                    if(data.code === 200) {
                        this.renderPrayers(data.data.timings);
                        this.startTimer(data.data.timings);
                    }
                }).catch(e => console.error(e));
            }
            renderPrayers(timings) {
                const keys = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                const t = TRANSLATIONS[STATE.lang];
                const map = { 'Fajr': t.fajr, 'Dhuhr': t.dhuhr, 'Asr': t.asr, 'Maghrib': t.maghrib, 'Isha': t.isha };
                
                // FIX: Clear list to prevent English text lingering
                this.contentRef.list.innerHTML = '';

                keys.forEach(k => {
                    let timeStr = timings[k];
                    if(timeStr.includes(':')) {
                        const [h, m] = timeStr.split(':').map(Number);
                        const suffix = h >= 12 ? 'PM' : 'AM';
                        const h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
                        timeStr = `${h12}:${m < 10 ? '0'+m : m} ${suffix}`;
                    }
                    this.contentRef.list.innerHTML += `<div class="prayer-row" id="row-${this.id}-${k}"><span>${map[k]}</span><span>${timeStr}</span></div>`;
                });
                
                // Update header translation
                this.contentRef.header.innerText = TRANSLATIONS[STATE.lang].prayerWidget;
            }
            startTimer(timings) {
                if(this.timerInterval) clearInterval(this.timerInterval);
                const update = () => {
                    const now = new Date();
                    const nowTime = now.getHours() * 60 + now.getMinutes();
                    const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                    
                    // FIX: Initialize properly
                    let nextPrayer = 'Fajr';
                    let nextTimeDiff = 1440; // Default to max mins (approx 24h)
                    
                    for(let p of prayers) {
                        const [h, m] = timings[p].split(':').map(Number);
                        const pTime = h * 60 + m;
                        if(pTime > nowTime && pTime < nextTimeDiff) { nextTimeDiff = pTime - nowTime; nextPrayer = p; }
                    }
                    
                    // Highlight Active
                    document.querySelectorAll(`[id^="row-${this.id}"]`).forEach(el => el.classList.remove('active'));
                    const activeRow = document.getElementById(`row-${this.id}-${nextPrayer}`);
                    if(activeRow) activeRow.classList.add('active');

                    // Progress Bar & Label Logic
                    let prevPrayer = null, prevTime = 0;
                    for(let i=0; i<prayers.length; i++) {
                        const [h, m] = timings[prayers[i]].split(':').map(Number);
                        const pTime = h * 60 + m;
                        if(pTime < nowTime) { prevPrayer = prayers[i]; prevTime = pTime; }
                    }
                    
                    const t = TRANSLATIONS[STATE.lang];
                    const bar = this.contentRef.bar;
                    const label = this.contentRef.nextLabel;

                    if(prevPrayer) {
                        const timeSince = nowTime - prevTime;
                        if(timeSince <= 30) {
                            const pct = (timeSince / 30) * 100;
                            bar.style.width = `${pct}%`;
                            label.innerText = `${t.iqamahIn} ${30 - timeSince}m`;
                        } else {
                            bar.style.width = '100%'; bar.style.opacity = '0.3';
                            
                            // Hours Logic
                            let timeString = `${nextTimeDiff}m`;
                            if(nextTimeDiff > 60) {
                                const hours = Math.floor(nextTimeDiff / 60);
                                const mins = nextTimeDiff % 60;
                                timeString = `${hours}h ${mins}m`;
                            }
                            
                            // Use translation for the prayer name
                            label.innerText = `${t.nextPrayer}: ${TRANSLATIONS[STATE.lang][nextPrayer.toLowerCase()]} (${timeString})`;
                        }
                    } else {
                         bar.style.width = '0%'; 
                         label.innerText = `${t.nextPrayer}: Fajr`;
                    }
                    
                    // Refresh Hijri
                    if(now.getSeconds() === 0) {
                        const hijriDate = new Intl.DateTimeFormat(STATE.lang === 'ar' ? 'ar-SA-u-ca-islamic' : 'en-US-u-ca-islamic', { dateStyle: 'long', calendar: 'islamic' }).format(now);
                        if(this.contentRef.hijri) this.contentRef.hijri.innerText = hijriDate;
                    }
                };
                update(); this.timerInterval = setInterval(update, 1000);
            }
        }

        class ToDoWidget extends Widget {
            constructor(...args) {
                super(...args);
                this.minW = 3; this.minH = 3;
            }
            updateContent(container) {
                // Container for list
                const list = document.createElement('div');
                list.className = 'todo-container';
                list.id = `todo-list-${this.id}`;
                this.contentRef = { list };
                
                // Input Area
                const input = document.createElement('input');
                input.className = 'todo-input';
                input.placeholder = TRANSLATIONS[STATE.lang].todoPlaceholder;
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.addTodoItem(input.value);
                        input.value = '';
                    }
                });
                container.appendChild(input);
                container.appendChild(list);
            }
            
            addTodoItem(text) {
                if(!text.trim()) return;
                const item = { id: Date.now() + Math.random(), text: text, done: false };
                this.data.items = this.data.items || [];
                this.data.items.push(item);
                this.renderList();
                saveLayout();
            }

            toggleItem(id) {
                const item = this.data.items.find(i => i.id === id);
                if(item) {
                    item.done = !item.done;
                    this.renderList();
                    saveLayout();
                }
            }

            renderList() {
                this.contentRef.list.innerHTML = '';
                if(!this.data.items) return;

                this.data.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `todo-item ${item.done ? 'done' : ''}`;
                    div.onclick = () => this.toggleItem(item.id);

                    const check = document.createElement('div');
                    check.className = 'todo-check';
                    const span = document.createElement('span');
                    span.innerText = item.text;

                    if (STATE.lang === 'rtl') {
                        div.appendChild(span);
                        div.appendChild(check);
                    } else {
                        div.appendChild(check);
                        div.appendChild(span);
                    }
                    this.contentRef.list.appendChild(div);
                });
            }

            refreshData() {
                // Update placeholder
                const input = this.el.querySelector('.todo-input');
                if(input) input.placeholder = TRANSLATIONS[STATE.lang].todoPlaceholder;
                
                // Re-render list to ensure it's populated
                this.renderList();
            }
        }

        class NotesWidget extends Widget {
            constructor(...args) {
                super(...args);
                this.minW = 2; this.minH = 2;
            }
            updateContent(container) {
                const area = document.createElement('textarea');
                area.className = 'notes-area';
                area.placeholder = STATE.lang === 'ar' ? "Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..." : "Type your notes here...";
                area.value = this.data.text || "";
                area.addEventListener('input', (e) => { this.data.text = e.target.value; saveLayout(); });
                this.contentRef = { area }; 
                container.appendChild(area);
            }
            refreshData() {
                if(this.contentRef.area) {
                    this.contentRef.area.placeholder = STATE.lang === 'ar' ? "Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..." : "Type your notes here...";
                }
            }
        }

        class BookmarkWidget extends Widget {
            constructor(...args) {
                super(...args);
                this.minW = 1; this.minH = 1;
            }
            render() {
                this.el = document.createElement('a');
                this.el.className = `widget w-bookmark`;
                this.el.href = this.data.url || '#'; this.el.target = "_blank";
                const content = document.createElement('div'); content.className = 'widget-content';
                this.updateContent(content); this.el.appendChild(content);
                const controls = document.createElement('div'); controls.className = 'widget-controls';
                const closeBtn = document.createElement('button'); closeBtn.className = 'mini-btn'; closeBtn.innerHTML = 'Ã—';
                closeBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); removeWidget(this.id); }; controls.appendChild(closeBtn);
                const handle = document.createElement('div'); handle.className = 'widget-drag-handle'; handle.addEventListener('mousedown', (e) => { e.preventDefault(); startDrag(e, this); });
                const resizer = document.createElement('div'); resizer.className = 'widget-resize-handle'; resizer.addEventListener('mousedown', (e) => { e.preventDefault(); startResize(e, this); });
                this.el.appendChild(handle); this.el.appendChild(resizer); this.el.appendChild(controls);
                DOM.container.appendChild(this.el);
                this.updateStyle();
            }
            updateContent(container) {
                const icon = document.createElement('div'); icon.className = 'bookmark-icon';
                const title = document.createElement('div'); title.className = 'bookmark-title';
                container.appendChild(icon); container.appendChild(title);
                this.contentRef = { icon, title };
                if (this.data.color) {
                    this.el.style.backgroundColor = this.data.color;
                    this.el.style.color = isLightColor(this.data.color) ? '#000' : '#fff';
                }
            }
            refreshData() {
                this.contentRef.icon.innerText = this.data.icon || 'ðŸ”—';
                this.contentRef.title.innerText = this.data.title || 'Link';
            }
        }

        function isLightColor(hex) {
            const r = parseInt(hex.substr(1, 2), 16), g = parseInt(hex.substr(3, 2), 16), b = parseInt(hex.substr(5, 2), 16);
            return ((r * 299 + g * 587 + b * 114) / 1000) > 155;
        }

        async function fetchWeather(query, widgetInstance) {
            try {
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${query.lat}&longitude=${query.lon}&current=temperature_2m,weather_code&timezone=auto`);
                const weatherData = await weatherRes.json();
                widgetInstance.weatherCache = { city: query.name, temp: weatherData.current.temperature_2m, icon: getWMOIcon(weatherData.current.weather_code) };
                widgetInstance.lastWeatherUpdate = Date.now();
                widgetInstance.lastCityName = query.name;
                widgetInstance.renderCachedWeather();
            } catch (e) { console.error("Weather Error", e); }
        }

        function getWMOIcon(code) {
            const codes = { 0: 'â˜€ï¸', 1: 'ðŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸', 45: 'ðŸŒ«ï¸', 51: 'ðŸŒ§ï¸', 61: 'ðŸŒ§ï¸', 71: 'â„ï¸', 95: 'â›ˆï¸' };
            return codes[code] || 'ðŸŒ¡ï¸';
        }

        function handleLocationChange() {
            const id = DOM.locSelect.value;
            const selection = UAE_LOCATIONS.find(l => l.id === id);
            STATE.currentLoc = selection;
            if(selection.id === 'auto') {
                if(!navigator.geolocation) return alert("Geo not supported");
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        STATE.geoCache = { lat: pos.coords.latitude, lon: pos.coords.longitude };
                        STATE.widgets.filter(w => w.type === 'weather' || w.type === 'prayer').forEach(w => w.refreshData());
                        saveSettings();
                    },
                    (err) => alert("Location denied")
                );
            } else {
                STATE.geoCache = null;
                STATE.widgets.filter(w => w.type === 'weather' || w.type === 'prayer').forEach(w => w.refreshData());
                saveSettings();
            }
        }

        // --- INTERACTION LOGIC ---

        function startDrag(e, widget) {
            if (!STATE.isEditing) return; e.preventDefault(); e.stopPropagation();
            STATE.dragTarget = widget; STATE.startX = e.clientX; STATE.startY = e.clientY;
            STATE.initialLeft = parseFloat(widget.el.style.left); STATE.initialTop = parseFloat(widget.el.style.top);
            widget.el.style.transition = 'none';
            DOM.container.appendChild(widget.el); 
        }

        function startResize(e, widget) {
            if (!STATE.isEditing) return; e.preventDefault(); e.stopPropagation();
            STATE.resizeTarget = widget;
            STATE.startX = e.clientX; STATE.startY = e.clientY;
            STATE.initialLeft = parseFloat(widget.el.style.left); STATE.initialTop = parseFloat(widget.el.style.top);
            
            const rect = widget.el.getBoundingClientRect();
            STATE.initialPixelW = rect.width;
            STATE.initialPixelH = rect.height;
            STATE.initialW = widget.w;
            STATE.initialH = widget.h;

            widget.el.style.transition = 'none';
        }

        window.addEventListener('mousemove', (e) => {
            showUI();
            if (STATE.dragTarget) {
                const dx = e.clientX - STATE.startX; const dy = e.clientY - STATE.startY;
                STATE.dragTarget.el.style.left = `${STATE.initialLeft + dx}px`;
                STATE.dragTarget.el.style.top = `${STATE.initialTop + dy}px`;
            }
            if (STATE.resizeTarget) {
                const dx = e.clientX - STATE.startX; const dy = e.clientY - STATE.startY;
                
                let newPixelW = Math.max(CONFIG.gridSize, STATE.initialPixelW + dx);
                let newPixelH = Math.max(CONFIG.gridSize, STATE.initialPixelH + dy);
                
                STATE.resizeTarget.el.style.width = `${newPixelW}px`;
                STATE.resizeTarget.el.style.height = `${newPixelH}px`;

                const dw = Math.round(dx / CONFIG.gridSize);
                const dh = Math.round(dy / CONFIG.gridSize);
                let newW = Math.max(STATE.resizeTarget.minW, STATE.initialW + dw);
                let newH = Math.max(STATE.resizeTarget.minH, STATE.initialH + dh);
                
                STATE.resizeTarget.w = newW;
                STATE.resizeTarget.h = newH;
            }
        });

        window.addEventListener('mouseup', () => {
            if (STATE.dragTarget) {
                const l = parseFloat(STATE.dragTarget.el.style.left); const t = parseFloat(STATE.dragTarget.el.style.top);
                let newGridX = Math.round(l / CONFIG.gridSize); let newGridY = Math.round(t / CONFIG.gridSize);
                STATE.dragTarget.x = newGridX; STATE.dragTarget.y = newGridY;
                const maxCols = Math.ceil(window.innerWidth / CONFIG.gridSize); const maxRows = Math.ceil(window.innerHeight / CONFIG.gridSize);
                if (STATE.dragTarget.x < 0) STATE.dragTarget.x = 0; if (STATE.dragTarget.y < 0) STATE.dragTarget.y = 0;
                if (STATE.dragTarget.x > maxCols - 1) STATE.dragTarget.x = maxCols - 1; if (STATE.dragTarget.y > maxRows - 1) STATE.dragTarget.y = maxRows - 1;
                STATE.dragTarget.updateStyle(); STATE.dragTarget = null; saveLayout();
            }
            if (STATE.resizeTarget) {
                STATE.resizeTarget.updateStyle();
                STATE.resizeTarget = null; saveLayout();
            }
        });

        // --- INITIALIZATION ---

        function init() {
            try {
                // 1. Load Theme & Language First
                const savedTheme = Storage.get('widget_theme') || 'default';
                DOM.themeSelect.value = savedTheme; applyTheme(savedTheme);

                const savedLang = Storage.get('widget_lang') || 'en';
                STATE.lang = savedLang; 
                DOM.langSelect.value = savedLang;
                updateLanguage(savedLang);

                // 2. Load Background
                const savedBg = Storage.get('widget_bg');
                // FIX: Apply immediately if saved, else default
                DOM.bg.style.backgroundImage = savedBg ? `url('${savedBg}')` : `url('${CONFIG.defaultBg}')`;
                
                // 3. Populate Location Dropdown
                DOM.locSelect.innerHTML = '';
                UAE_LOCATIONS.forEach((loc, index) => {
                    const opt = document.createElement('option'); opt.value = loc.id;
                    opt.innerText = (STATE.lang === 'ar' && loc.arName) ? loc.arName : loc.name;
                    if(loc.id === STATE.currentLoc.id) opt.selected = true;
                    DOM.locSelect.appendChild(opt);
                });

                // 4. Load Layout or Default
                const savedLayout = Storage.get('widget_layout');
                if (savedLayout) {
                    try {
                        const parsed = JSON.parse(savedLayout);
                        parsed.forEach(wData => createWidgetFromData(wData));
                    } catch(e) { console.error("Layout corrupt", e); setupDefaultLayout(); }
                } else { setupDefaultLayout(); }

                // 5. Geo
                const savedLoc = Storage.get('widget_loc');
                if(savedLoc) {
                    const locObj = UAE_LOCATIONS.find(l => l.id === savedLoc);
                    if(locObj) { STATE.currentLoc = locObj; DOM.locSelect.value = locObj.id; }
                }
                try { detectLocationAndInitialize(); } catch(e) { console.warn("Geo init failed", e); }

                DOM.gridOverlay.style.setProperty('--cell-size', CONFIG.gridSize + 'px');

                setInterval(() => STATE.widgets.forEach(w => w.refreshData()), 60000);
                document.addEventListener('mousemove', showUI); document.addEventListener('click', showUI);
                STATE.idleTimer = setTimeout(hideUI, CONFIG.inactivityTimeout);
                window.addEventListener('resize', () => STATE.widgets.forEach(w => w.updateStyle()));
            } catch (e) {
                console.error("Critical Init Error:", e);
                setupDefaultLayout();
            }
        }

        function createWidgetFromData(data) {
            let w;
            switch(data.type) {
                case 'time': w = new TimeWidget(data.id, data.type, data.x, data.y, data.w, data.h, data.data); break;
                case 'weather': w = new WeatherWidget(data.id, data.type, data.x, data.y, data.w, data.h, data.data); break;
                case 'prayer': w = new PrayerWidget(data.id, data.type, data.x, data.y, data.w, data.h, data.data); break;
                case 'todo': w = new ToDoWidget(data.id, data.type, data.x, data.y, data.w, data.h, data.data); break;
                case 'notes': w = new NotesWidget(data.id, data.type, data.x, data.y, data.w, data.h, data.data); break;
                case 'bookmark': w = new BookmarkWidget(data.id, data.type, data.x, data.y, data.w, data.h, data.data); break;
                default: w = new Widget(data.id, data.type, data.x, data.y, data.w, data.h, data.data);
            }
            STATE.widgets.push(w);
        }

        function setupDefaultLayout() {
            const timeW = new TimeWidget('w_time_def', 'time', 2, 2, 4, 4);
            const weatherW = new WeatherWidget('w_weather_def', 'weather', 8, 2, 3, 4);
            const prayerW = new PrayerWidget('w_prayer_def', 'prayer', 2, 7, 4, 5);
            const todoW = new ToDoWidget('w_todo_def', 'todo', 2, 6, 3, 3);
            STATE.widgets.push(timeW, weatherW, prayerW, todoW);
            saveLayout();
        }

        function removeWidget(id) {
            const idx = STATE.widgets.findIndex(w => w.id === id);
            if (idx > -1) { STATE.widgets[idx].el.remove(); STATE.widgets.splice(idx, 1); saveLayout(); }
        }

        function saveLayout() {
            const serializable = STATE.widgets.map(w => ({ id: w.id, type: w.type, x: w.x, y: w.y, w: w.w, h: w.h, data: w.data }));
            Storage.set('widget_layout', JSON.stringify(serializable));
        }

        function saveSettings() {
            Storage.set('widget_loc', STATE.currentLoc.id);
        }

        function showUI() {
            DOM.uiLayer.style.opacity = '1'; clearTimeout(STATE.idleTimer); STATE.idleTimer = setTimeout(hideUI, CONFIG.inactivityTimeout);
        }
        function hideUI() {
            if (!STATE.isEditing && !DOM.settingsPanel.classList.contains('active') && !DOM.addWidgetPanel.classList.contains('active')) DOM.uiLayer.style.opacity = '0';
        }

        function toggleEditMode() {
            STATE.isEditing = !STATE.isEditing;
            document.body.classList.toggle('edit-mode', STATE.isEditing);
            DOM.editBtn.innerText = STATE.isEditing ? (STATE.lang === 'ar' ? "ØªÙ…" : "Done") : (STATE.lang === 'ar' ? "ØªØ¹Ø¯ÙŠÙ„" : "Edit Layout");
            if(STATE.isEditing) showUI();
        }

        // --- UI EVENTS ---
        DOM.addWidgetBtn.onclick = () => {
            DOM.addWidgetPanel.classList.toggle('active'); DOM.settingsPanel.classList.remove('active'); showUI();
        };
        DOM.settingsBtn.onclick = () => {
            DOM.settingsPanel.classList.toggle('active'); DOM.addWidgetPanel.classList.remove('active'); showUI();
        };

        document.getElementById('new-widget-type').onchange = (e) => {
            const val = e.target.value;
            document.querySelectorAll('.dynamic-form').forEach(el => el.classList.remove('active'));
            if(val === 'bookmark') document.getElementById('form-bookmark').classList.add('active');
        };

        document.getElementById('confirm-add-widget').onclick = () => {
            const type = document.getElementById('new-widget-type').value;
            const id = 'w_' + Date.now();
            let x = 0, y = 0, data = {}, w = 2, h = 2;
            if (type === 'time') { w = 4; h = 4; }
            if (type === 'weather') { w = 3; h = 4; }
            if (type === 'prayer') { w = 4; h = 5; }
            if (type === 'todo') { w = 3; h = 3; data.items = []; }
            if (type === 'notes') { w = 3; h = 4; }
            if (type === 'bookmark') {
                w = 2; h = 2;
                data.title = document.getElementById('bm-title').value || "Link";
                data.url = document.getElementById('bm-url').value || "#";
                data.icon = document.getElementById('bm-icon').value || "ðŸ”—";
                data.color = document.getElementById('bm-color').value || "#ff9500";
            }
            createWidgetFromData({ id, type, x, y, w, h, data });
            saveLayout();
            DOM.addWidgetPanel.classList.remove('active');
        };

        DOM.editBtn.onclick = toggleEditMode;
        DOM.gridSizeInput.oninput = (e) => {
            const val = e.target.value; CONFIG.gridSize = parseInt(val);
            DOM.fileSizeVal.innerText = val + 'px';
            DOM.gridOverlay.style.setProperty('--cell-size', val + 'px');
            STATE.widgets.forEach(w => w.updateStyle()); saveLayout(); 
        };
        DOM.themeSelect.onchange = (e) => applyTheme(e.target.value);
        DOM.langSelect.onchange = (e) => updateLanguage(e.target.value);
        DOM.fontSelect.onchange = (e) => {
            document.documentElement.style.setProperty('--font-stack', e.target.value); Storage.set('widget_font', e.target.value);
        };
        DOM.locSelect.onchange = handleLocationChange;

        // --- BACKGROUND WORKFLOW ---

        // 1. User Uploads Image
        document.getElementById('bg-upload').onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    STATE.pendingBg = ev.target.result;
                    // Show immediately as Preview
                    DOM.bg.style.backgroundImage = `url('${STATE.pendingBg}')`;
                    // Show "Apply" button
                    DOM.applyBgBtn.style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
            }
        };

        // 2. User Clicks Apply
        DOM.applyBgBtn.onclick = () => {
            if(STATE.pendingBg) {
                try {
                    Storage.set('widget_bg', STATE.pendingBg);
                    DOM.applyBgBtn.style.display = 'none'; // Hide button
                } catch (e) {
                    alert(STATE.lang === 'ar' ? "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§ Ù„Ù„Ø­ÙØ¸." : "Storage Error: Image too large to save permanently. It will work now, but won't be saved on refresh.");
                }
            }
        };

        // 3. User Clicks Reset
        document.getElementById('reset-bg').onclick = () => {
            STATE.pendingBg = null;
            Storage.remove('widget_bg');
            DOM.bg.style.backgroundImage = `url('${CONFIG.defaultBg}')`;
            DOM.applyBgBtn.style.display = 'none';
        };

        document.getElementById('reset-layout').onclick = () => {
            if(confirm(STATE.lang === 'ar' ? "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ®ØµÙŠØµ." : "Are you sure? This will reset all widgets.")) {
                Storage.remove('widget_layout');
                DOM.container.innerHTML = ''; STATE.widgets = []; setupDefaultLayout();
            }
        };

        init();
    </script>
</body>
</html>
